openapi: "3.0.3"
info:
  title: Quiz Game API
  version: "1.0"
  description: API для мультиплеерной викторины
servers:
  - url: http://localhost:8000
    description: Локальный сервер
tags:
  - name: Authentication
    description: Авторизация, регистрация пользователей
  - name: User operations
    description: Операции с пользователем
  - name: Finding
    description: Нахождение игр
  - name: Game
    description: Ожидание и игра
  - name: Social
    description: Социальные взаимодействия

paths:
  /main:
    get:
      summary: Главный хаб
      description: Страница с открытыми комнатами и общей информацией
      tags: ["Finding"]
      responses:
        "200":
          headers:
            Access-Control-Allow-Origin:
              schema:
                type: string
              example: https://trusted.com
          description: Главная открыта
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PublicLobbies"
        "400":
          $ref: "#/components/responses/400"
        "401":
          $ref: "#/components/responses/401"
        "403":
          $ref: "#/components/responses/403"
        "404":
          $ref: "#/components/responses/404"
        "405":
          $ref: "#/components/responses/405"
        "500":
          $ref: "#/components/responses/500"

  /search:
    get:
      summary: Страница поиска
      description: Возможность найти пользователя по нику или почте, лобби по ключу
      tags: ["Finding"]
      parameters:
        - name: search
          in: query
          schema:
            type: string
            default: ""
      responses:
        "200":
          headers:
            Access-Control-Allow-Origin:
              schema:
                type: string
              example: https://trusted.com
          description: "Поиск открыт"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Results"
        "400":
          $ref: "#/components/responses/400"
        "401":
          $ref: "#/components/responses/401"
        "403":
          $ref: "#/components/responses/403"
        "404":
          $ref: "#/components/responses/404"
        "405":
          $ref: "#/components/responses/405"
        "500":
          $ref: "#/components/responses/500"

  /friends:
    get:
      summary: Друзья пользователя
      tags: ["Social"]
      security:
        - BearerAuth: []
      responses:
        "200":
          headers:
            Access-Control-Allow-Origin:
              schema:
                type: string
              example: https://trusted.com
          description: Успешный вход
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FriendsList"
              example:
                count: 2
                friends:
                  - id: 2
                    username: "misha336"
                    avatar: "5.png"
                  - id: 3
                    username: "nikitos"
                    avatar: "3.png"
        "400":
          $ref: "#/components/responses/400"
        "401":
          $ref: "#/components/responses/401"
        "403":
          $ref: "#/components/responses/403"
        "404":
          $ref: "#/components/responses/404"
        "405":
          $ref: "#/components/responses/405"
        "500":
          $ref: "#/components/responses/500"


  /leaderboard:
    get:
      parameters:
        - name: period
          in: query
          schema:
            type: string
            enum: [week, month, year, all]
            default: all
          description: Период получения очков
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
          description: Пагинация, 10 на одной странице
      description: Список игроков отсортированных по рейтингу и периоду с пагинацией
      tags: ["Social"]
      responses:
        "200":
          headers:
            Access-Control-Allow-Origin:
              schema:
                type: string
              example: https://trusted.com
          description: Рейтинг открыт
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LeaderBoardData"
              example:
                period: all
                players: [
                  {
                    username: nikitos,
                    earned_points: 283,
                    possible_points: 400,
                    average: "71%"
                  },
                  {
                    username: anton228,
                    earned_points: 184,
                    possible_points: 320,
                    average: "58%"
                  },
                  {
                    username: anton88,
                    earned_points: 89,
                    possible_points: 240,
                    average: "37%"
                  },
                ]
        "400":
          $ref: "#/components/responses/400"
        "401":
          $ref: "#/components/responses/401"
        "403":
          $ref: "#/components/responses/403"
        "404":
          $ref: "#/components/responses/404"
        "405":
          $ref: "#/components/responses/405"
        "500":
          $ref: "#/components/responses/500"

  /lobby/{lobbyId}:
    get:
      summary: Страница ожидания игры
      description: Вход в чужой лобби
      tags: ["Game"]
      parameters:
        - name: lobbyId
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
          description: id лобби
      responses:
        "200":
          headers:
            Access-Control-Allow-Origin:
              schema:
                type: string
              example: https://trusted.com
          description: Успешный вход
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PublicLobby"
        "400":
          $ref: "#/components/responses/400"
        "401":
          $ref: "#/components/responses/401"
        "403":
          $ref: "#/components/responses/403"
        "404":
          $ref: "#/components/responses/404"
        "405":
          $ref: "#/components/responses/405"
        "500":
          $ref: "#/components/responses/500"

    post:
      description: Создание и вход в лобби
      tags: ["Game"]
      parameters:
        - name: lobbyId
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
          description: id лобби
      security:
        - BearerAuth: []
      responses:
        "201":
          headers:
            Access-Control-Allow-Origin:
              schema:
                type: string
              example: https://trusted.com
          description: Комната создана
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PrivateLobby"
        "400":
          $ref: "#/components/responses/400"
        "401":
          $ref: "#/components/responses/401"
        "403":
          $ref: "#/components/responses/403"
        "404":
          $ref: "#/components/responses/404"
        "405":
          $ref: "#/components/responses/405"
        "500":
          $ref: "#/components/responses/500"

  /game/{gameId}/ws:
    get:
      description: WebSocket соединение для игрового процесса, используется временный токен сессии
      tags: ["Game"]
      parameters:
        - name: gameId
          in: path
          required: true
          schema:
            type: integer
      security:
        - BearerAuth: []
      responses:
        "200":
          headers:
            Access-Control-Allow-Origin:
              schema:
                type: string
              example: https://trusted.com
          description: Успешный вход
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GameData"
        "400":
          $ref: "#/components/responses/400"
        "401":
          $ref: "#/components/responses/401"
        "403":
          $ref: "#/components/responses/403"
        "404":
          $ref: "#/components/responses/404"
        "405":
          $ref: "#/components/responses/405"
        "500":
          $ref: "#/components/responses/500"

  /users/{userId}:
    get:
      summary: Страница пользователя
      tags: ["User operations"]
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
          description: id пользователя
      responses:
        "200":
          headers:
            Access-Control-Allow-Origin:
              schema:
                type: string
              example: https://trusted.com
          description: Данные пользователя
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PublicUser"
        "400":
          $ref: "#/components/responses/400"
        "401":
          $ref: "#/components/responses/401"
        "403":
          $ref: "#/components/responses/403"
        "404":
          $ref: "#/components/responses/404"
        "405":
          $ref: "#/components/responses/405"
        "500":
          $ref: "#/components/responses/500"
  /registration:
    post:
      summary: Создание пользователя
      tags: ["Authentication"]
      requestBody:
        required: true
        description: Данные пользователя
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserRegistration"
            example:
              username: "anton88"
              email: "anton@quiz.com"
              password: "S0m3_pa55word!"
      responses:
        "201":
          headers:
            Access-Control-Allow-Origin:
              schema:
                type: string
              example: https://trusted.com
          description: Пользователь создан, перенаправление на главную
          content:
            application/json:
              schema:
                type: object
                properties:
                  redirect:
                    type: string
                    example: /authorization
        "400":
          $ref: "#/components/responses/400"
        "401":
          $ref: "#/components/responses/401"
        "403":
          $ref: "#/components/responses/403"
        "404":
          $ref: "#/components/responses/404"
        "405":
          $ref: "#/components/responses/405"
        "500":
          $ref: "#/components/responses/500"
  
  /authorization:
    post:
      summary: Вход в аккаунт
      tags: ["Authentication"]
      requestBody:
        required: true
        description: Данные пользователя
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserAuthorization"
            example:
              email: "anton@quiz.com"
              password: "S0m3_pa55word!"
      responses:
        "200":
          headers:
            Access-Control-Allow-Origin:
              schema:
                type: string
              example: https://trusted.com
          description: Успешный вход, перенаправление на главную
          content:
            application/json:
              schema:
                type: object
                properties:
                  redirect:
                    type: string
                    example: /main
        "400":
          $ref: "#/components/responses/400"
        "401":
          $ref: "#/components/responses/401"
        "403":
          $ref: "#/components/responses/403"
        "404":
          $ref: "#/components/responses/404"
        "405":
          $ref: "#/components/responses/405"
        "500":
          $ref: "#/components/responses/500"

  /profile:
    get:
      summary: Профиль пользователя
      description: Полные данные пользователя, история игр, рейтинг
      tags: ["User operations"]
      security:
        - BearerAuth: []
      responses:
        "200":
          headers:
            Access-Control-Allow-Origin:
              schema:
                type: string
              example: https://trusted.com
          description: Доступ разрешен
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PrivateUser"
        "400":
          $ref: "#/components/responses/400"
        "401":
          $ref: "#/components/responses/401"
        "403":
          $ref: "#/components/responses/403"
        "404":
          $ref: "#/components/responses/404"
        "405":
          $ref: "#/components/responses/405"
        "500":
          $ref: "#/components/responses/500"
                
components:
  responses:
        "400":
          description: Ошибка сервера
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "400 Bad request"
                message: При выполнении запроса произошла ошибка, попробуйте ещё раз
        "401":
          description: Неверные данные, перенаправление на авторизацию
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "401 Unauthorized"
                message: Войдите в аккаунт для выполнения этого действия
        "403":
          description: Нет разрешения на вход
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "403 Forbidden"
                message: Нет разрешения на вход
        "404":
          description: Страница не найдена
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "404 Not found"
                message: Страница не найдена, проверьте URL запроса
        "405":
          description: метода не существует или доступен администратору
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "405 Method not allowed"
                message: Данный метод не поддерживается
        "500":
          description: Ошибка обработки данных
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "500 Internal server error"
                message: Наш сервер столкнулся с непредвиденной ошибкой, подождите пока мы его исправляем и повторите запрос

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    ErrorResponse:
      description: Информация об ошибках HTTP
      type: object
      properties:
        error:
          type: string
        message:
          type: string
      required: [error, message]

    GameData:
      description: Информация о проведенной игре и очках, полученных игроком
      type: object
      properties:
        id:
          type: integer
        user_id:
          type: integer
        category:
          type: string
        difficulty:
          type: string
          enum: [easy, medium, hard, mixed]
        possible_points:
          type: integer
        earned_points:
          type: integer
        date:
          type: string
          format: date-time
      required: [id, user_id, category, difficulty, possible_points, earned_points, date]

    LeaderBoardData:
      description: Информация о лучших игроках
      type: object
      properties:
        period:
          type: string
          enum: [week, month, year, all]
        players:
          type: array
          items:
            type: object
            properties:
              id: 
                type: integer
              username: 
                type: string
              avatar:
                type: string
              earned_points:
                type: integer
              possible_points:
                type: integer
              average:
                type: string
                example: "42%"
            required: [id, username, avatar, earned_points, possible_points, average]
      required: [period, players]

    PublicUserShort:
      description: Информация о пользователе сокращенная
      type: object
      properties:
        id:
          type: integer
        username:
          type: string
        avatar: 
          type: string
        total_games:
          type: integer
        average:
          type: string
      required: [id, username, avatar, total_games, average]

    Results:
      description: Результат поиска
      type: object
      properties:
        lobbies:
          $ref: "#/components/schemas/PublicLobbies"
        users:
          type: array
          items:
            $ref: "#/components/schemas/PublicUserShort"
      required: [lobbies, users]

      example:
        lobbies: [
          {
            title: TOP 10 LINUX QUESTIONS,
            category: hard,
            max_players: 4,
            current_players: 2,
            created_at: "2025-07-03T18:23:00Z"
          },
          {
            title: TOP 10 VS STUDIO QUESTIONS,
            category: easy,
            max_players: 4,
            current_players: 2,
            created_at: "2025-07-03T18:23:00Z"
          }
        ]
        users: [
          {
            id: 1,
            username: misha336,
            avatar: "1.png",
            total_games: 31,
            average: "74%"
          },
          {
            id: 5,
            username: nikitos,
            avatar: "6.png",
            total_games: 26,
            average: "61%"
          }
        ]

    PublicUser:
      description: Информация о публичной записи пользователя
      type: object
      properties:
        id:
          type: integer
        username:
          type: string
          example: Joe Biden
        total_games: 
          type: integer
          example: 273
        possible_points:
          type: integer
          example: 2730
        earned_points:
          type: integer
          example: 1956
        friends:
          $ref: "#/components/schemas/FriendsList"
        avatar:
          type: string
          example: "4.png"
        average: 
          type: string
          example: "42%"
      required: [id, username, total_games, possible_points, earned_points, avatar, average, friends]

    PublicLobbies:
      description: Информация о публичных лобби, сокращенная
      type: array
      items:
        type: object
        properties:
          title: 
            type: string
            example: TOP 10 LINUX QUESTIONS
          category: 
            type: string
            example: hard
          max_players:
            type: integer
            example: 4
          current_players:
            type: integer
            example: 2
          created_at:
            type: string
            format: date-time
            example: "2025-07-03T18:23:00Z"
        required: [title, category, max_players, current_players, created_at]
        
    FriendsList:
      description: Информация о друзьях пользователя
      type: object
      properties:
        count:
          type: integer
          description: Количество друзей
        friends:
          type: array
          items:
            type: object
            properties:
              id:
                type: integer
              username:
                type: string
              avatar:
                type: string
      required: [count, friends]
      example:
        count: 2
        friends: [
          {
            id: 1,
            username: nikitos,
            avatar: "3.png"
          },
          {
            id: 3,
            username: misha336,
            avatar: "1.png"
          }
        ]

    PrivateUser:
      description: Информация о приватной записи пользователя
      allOf:
        - $ref: "#/components/schemas/PublicUser"
        - type: object
          properties:
            email:
              type: string
              format: email
              example: example@example.com
          required: [email]

    PublicLobby:
      description: Информация о публичном лобби
      type: object
      properties:
        id:
          type: integer
          format: int64
          example: 1
        title:
          type: string
        category:
          type: string
        difficulty:
          type: string
          enum: [easy, medium, hard, mixed]
        creator:
          $ref: "#/components/schemas/PublicUserShort"
        players:
          type: array
          items: 
            $ref: "#/components/schemas/PublicUserShort"
        visibility:
          type: string
          enum: [public, private, friends]
        status:
          type: string
          enum: [waiting, starting]
        max_players:
          type: integer
          default: 4
        created_at:
          type: string
          format: date-time
          example: "2025-07-03T18:23:00Z"
      required: [id, title, category, difficulty, creator, players, visibility, status, max_players, created_at]

    PrivateLobby:
      description: Информация о приватном лобби
      allOf:
        - $ref: "#/components/schemas/PublicLobby"
        - type: object
          properties:
            key: 
              type: string
              example: ff25a9I00
              description: ключ комнаты
          required: [key]

    UserRegistration:
      description: Форма регистрации
      type: object
      properties:
        username: 
          type: string
          example: "nikitos"
        email:
          type: string
          example: n1k1ttoz@quiz.com
        password:
          type: string
          format: password
          minLength: 10
          example: S0m3_pa55word!
      required: [username, email, password]
    
    UserAuthorization:
      description: Форма авторизации
      type: object
      properties:
        email:
          type: string
          example: n1k1ttoz@quiz.com
        password:
          type: string
          format: password
          minLength: 10
          example: S0m3_pa55word
      required: [email, password]
